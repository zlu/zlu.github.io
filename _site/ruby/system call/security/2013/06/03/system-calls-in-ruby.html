<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>System Calls In Ruby</title>

  <!-- syntax highlighting CSS -->
  <link rel="stylesheet" href="/css/syntax.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/zhaolu.css">

  <!-- <link href='http://fonts.googleapis.com/css?family=Trykker' rel='stylesheet' type='text/css'> -->

  <link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">

  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

  <!-- Latest compiled and minified JavaScript -->
  <script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

</head>
<body>

<div class="container">
  <div class="header">
    <h1 class="title"><a href="/">blog@zlu</a></h1>
    <a class="extra" href="/">home</a>
    <a class="extra" href="/about">about</a>
  </div>

  <div class="row">
    <div class="col-md-4">
      
      <div style="margin-bottom: 10px;">
          <a href="/featured/2016/09/30/a-proper-goodbye.html">A Proper Goodbye</a><br>
          <span>09-30-2016</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/featured/heroku/postgres/performance/2016/03/02/taming-postgres-on-heroku.html">Taming Postgres on Heroku</a><br>
          <span>03-02-2016</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/featured/yoga/2014/05/26/an-unbiased-yogic-guide-to-san-francisco.html">An Unbiased Yogic Guide to San Francisco</a><br>
          <span>05-26-2014</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/update/2013/11/01/site-updates.html">Site Updates</a><br>
          <span>11-01-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/update/2013/09/29/site-updates.html">Site Updates</a><br>
          <span>09-29-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/rails/cms/2013/09/27/quicksurveyofrailscms.html">Quick Survey Of Rails CMS</a><br>
          <span>09-27-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/jekyll/github/plugin/2013/09/18/never-ending-journey-on-the-perfect-blogging-setup.html">The Never Ending Journey On The Perfect Blogging Setup</a><br>
          <span>09-18-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/system%20call/security/2013/06/03/system-calls-in-ruby.html">System Calls In Ruby</a><br>
          <span>06-03-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/rails/ruby/2013/05/29/initialization-is-an-interesting-thing.html">Initialization Is An Interesting Thing</a><br>
          <span>05-29-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/shell/bash/2013/05/27/lost-shell-commands.html">Lost Shell Commands?</a><br>
          <span>05-27-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/database/upgrade/sharedmemory/2013/02/04/postgres-gotchas.html">Postgres Gotchas</a><br>
          <span>02-04-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/rvm/2012/11/10/housekeeping-rvm.html">Housekeeping RVM</a><br>
          <span>11-10-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/system/2012/11/08/what-happened-to-fd-3-and-4-in-mri.html">What Happened to FD 3 and 4 in MRI</a><br>
          <span>11-08-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/deployment/apache/capistrano/2012/11/07/rolling-deployment.html">Rolling Deployment</a><br>
          <span>11-07-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/social/2012/11/01/encourage-social-sharing-in-china.html">Encouraging Social Sharing in China</a><br>
          <span>11-01-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/rails/2012/10/29/install-and-create-rails-4-dot-0-app.html">Install and Create Rails 4.0 App</a><br>
          <span>10-29-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/mongodb/activerecord/sql/2012/10/16/a-small-difference-between-mongoid-and-activerecord-query-interface.html">A Small Difference Between Mongoid and ActiveRecord Query Interface</a><br>
          <span>10-16-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/rails/gem/rvm/2012/10/16/segmentation-fault-with-rails-and-json.html">Segmentation fault with Rails and JSON</a><br>
          <span>10-16-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/dns/censorship/2012/08/30/accessing-facebook-in-vietnam.html">Accessing Facebook in Vietnam</a><br>
          <span>08-30-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/bash/gem/2012/07/31/uninstall-multiple-versions-of-multiple-ruby-gem.html">Uninstall Multiple Versions of Multiple Ruby Gems</a><br>
          <span>07-31-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/2012/07/19/pretty-print-json-in-command-line.html">Pretty Print JSON in Command Line</a><br>
          <span>07-19-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/mocking/rails/rspec/carrierwave/fog/s3/2012/07/17/testing-carrierwave-with-fog.html">Testing Carrierwave with Fog for Amazon S3</a><br>
          <span>07-17-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/emacs/2012/05/18/my-current-emacs.html">My Current Emacs</a><br>
          <span>05-18-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/bdd/agile/2012/05/13/tdd-by-jim-weirich.html">TDD by Jim Weirich</a><br>
          <span>05-13-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/wireshark/os%20x/mountain%20lion/2012/02/28/running-wireshark-on-mountain-lion.html">Running Wireshark on Mountain Lion</a><br>
          <span>02-28-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/os%20x/gem/mountain%20lion/2012/02/21/install-native-ruby-gem-in-mountain-lion-preview.html">Install Native Ruby Gem in Mountain Lion Preview</a><br>
          <span>02-21-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/tools/2012/02/14/rubymine-and-pivotaltracker-integration.html">RubyMine and PivotalTracker Integration</a><br>
          <span>02-14-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/2012/02/12/a-couple-things-to-watch-out-for-using-privatepub.html">A Couple Things to Watch Out For Using PrivatePub</a><br>
          <span>02-12-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/rspec/tdd/2012/02/12/rspec-arbitrary-handling-of-arguments.html">RSpec Arbitrary Handling of Arguments</a><br>
          <span>02-12-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/agile/2012/01/30/on-agile.html">On Agile</a><br>
          <span>01-30-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/git/2011/11/01/git-auto-complete.html">Git auto complete</a><br>
          <span>11-01-2011</span>
      </div>
      
    </div>
    <div class="col-md-8">
      <h2>System Calls In Ruby</h2>
<p class="meta">06-03-2013</p>

<p>There are a few ways to execute system commands in Ruby: backticks, system, exec, %x[], and Open3#popen3.
We will take a look at the their differences and briefly discuss security concerns of applying them.</p>

<h2 id="backticks-kernel">Backticks (Kernel#`)</h2>

<p>When using backticks, the result is returned as string.  Process status of method execution is stored in $?</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">006</span> <span class="o">&gt;</span> <span class="sb">`ls`</span>
 <span class="o">=&gt;</span> <span class="s2">"CHANGELOG.markdown</span><span class="se">\n</span><span class="s2">Gemfile</span><span class="se">\n</span><span class="s2">Gemfile.lock</span><span class="se">\n</span><span class="s2">README.markdown</span><span class="se">\n</span><span class="s2">Rakefile</span><span class="se">\n</span><span class="s2">_config.yml</span><span class="se">\n</span><span class="s2">config.rb</span><span class="se">\n</span><span class="s2">config.ru</span><span class="se">\n</span><span class="s2">plugins</span><span class="se">\n</span><span class="s2">public</span><span class="se">\n</span><span class="s2">sass</span><span class="se">\n</span><span class="s2">sass.old</span><span class="se">\n</span><span class="s2">source</span><span class="se">\n</span><span class="s2">source.old</span><span class="se">\n</span><span class="s2">"</span>
<span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">007</span> <span class="o">&gt;</span> <span class="vg">$?</span>
 <span class="o">=&gt;</span> <span class="c1">#&lt;Process::Status: pid 35977 exit 0&gt;</span>
<span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">00</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">_</span>
 <span class="o">=&gt;</span> <span class="c1">#&lt;Process::Status: pid 35977 exit 0&gt;</span>
<span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">00</span><span class="mi">9</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">.</span><span class="nf">success?</span>
 <span class="o">=&gt;</span> <span class="kp">true</span>
 </code></pre></figure>

<h2 id="x">%x</h2>

<p>%x() or %x[] is similar to using backticks.</p>

<h2 id="kernelsystem">Kernel#system</h2>

<p>When using system method, the result is true or false depending on whether the command is executed successfully.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="nb">system</span> <span class="s1">'ls'</span>
<span class="no">CHANGELOG</span><span class="p">.</span><span class="nf">markdown</span> <span class="no">README</span><span class="p">.</span><span class="nf">markdown</span>    <span class="n">config</span><span class="p">.</span><span class="nf">rb</span>          <span class="kp">public</span>             <span class="n">source</span>
<span class="no">Gemfile</span>            <span class="no">Rakefile</span>           <span class="n">config</span><span class="p">.</span><span class="nf">ru</span>          <span class="n">sass</span>               <span class="n">source</span><span class="p">.</span><span class="nf">old</span>
<span class="no">Gemfile</span><span class="p">.</span><span class="nf">lock</span>       <span class="n">_config</span><span class="p">.</span><span class="nf">yml</span>        <span class="n">plugins</span>            <span class="n">sass</span><span class="p">.</span><span class="nf">old</span>
 <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">003</span> <span class="o">&gt;</span> <span class="nb">system</span> <span class="s1">'ls a'</span>
<span class="ss">ls: a: </span><span class="no">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
 <span class="o">=&gt;</span> <span class="kp">false</span></code></pre></figure>

<h2 id="kernelexec">Kernel#exec</h2>

<p>exec replaces the current process by running the given external command.  If you invoke exec in irb, then the irb process
will be replaced by the running external command.  You will get the shell prompt back after exec finishes.  If you invoke
exec in a ruby program, that program will stop execution (just like the irb process).</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">zlu</span><span class="vi">@zlu</span><span class="o">-</span><span class="n">mba</span><span class="ss">:~</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">blog</span><span class="o">-</span><span class="n">zlu</span> <span class="p">(</span><span class="n">master</span> <span class="o">*</span><span class="p">)</span><span class="err">$</span> <span class="n">irb</span>
<span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="nb">exec</span> <span class="s1">'ls'</span>
<span class="no">CHANGELOG</span><span class="p">.</span><span class="nf">markdown</span> <span class="no">README</span><span class="p">.</span><span class="nf">markdown</span>    <span class="n">config</span><span class="p">.</span><span class="nf">rb</span>          <span class="kp">public</span>             <span class="n">source</span>
<span class="no">Gemfile</span>            <span class="no">Rakefile</span>           <span class="n">config</span><span class="p">.</span><span class="nf">ru</span>          <span class="n">sass</span>               <span class="n">source</span><span class="p">.</span><span class="nf">old</span>
<span class="no">Gemfile</span><span class="p">.</span><span class="nf">lock</span>       <span class="n">_config</span><span class="p">.</span><span class="nf">yml</span>        <span class="n">plugins</span>            <span class="n">sass</span><span class="p">.</span><span class="nf">old</span>
<span class="n">zlu</span><span class="vi">@zlu</span><span class="o">-</span><span class="n">mba</span><span class="ss">:~</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">blog</span><span class="o">-</span><span class="n">zlu</span> <span class="p">(</span><span class="n">master</span> <span class="o">*</span><span class="p">)</span><span class="err">$</span></code></pre></figure>

<h2 id="open3popen3">Open3#popen3</h2>

<p>popen3 executes the command while opening stdin, stdout, and stderr and a thread to wait for the command execution.</p>

<p><strong>stdout with successfully execution</strong></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">010</span> <span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">'open3'</span>
 <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">011</span> <span class="o">&gt;</span> <span class="no">Open3</span><span class="p">.</span><span class="nf">popen3</span> <span class="s1">'ls'</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="c1">#&lt;IO:fd 6&gt;, #&lt;IO:fd 7&gt;, #&lt;IO:fd 9&gt;, #&lt;Thread:0x007fcd928ece18 run&gt;]</span>
<span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">012</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">_</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="c1">#&lt;IO:fd 6&gt;, #&lt;IO:fd 7&gt;, #&lt;IO:fd 9&gt;, #&lt;Thread:0x007fcd928ece18 dead&gt;]</span>
<span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">014</span> <span class="o">&gt;</span> <span class="n">o</span><span class="p">.</span><span class="nf">read</span>
 <span class="o">=&gt;</span> <span class="s2">"CHANGELOG.markdown</span><span class="se">\n</span><span class="s2">Gemfile</span><span class="se">\n</span><span class="s2">Gemfile.lock</span><span class="se">\n</span><span class="s2">README.markdown</span><span class="se">\n</span><span class="s2">Rakefile</span><span class="se">\n</span><span class="s2">_config.yml</span><span class="se">\n</span><span class="s2">config.rb</span><span class="se">\n</span><span class="s2">config.ru</span><span class="se">\n</span><span class="s2">plugins</span><span class="se">\n</span><span class="s2">public</span><span class="se">\n</span><span class="s2">sass</span><span class="se">\n</span><span class="s2">sass.old</span><span class="se">\n</span><span class="s2">source</span><span class="se">\n</span><span class="s2">source.old</span><span class="se">\n</span><span class="s2">"</span></code></pre></figure>

<p><strong>stderr with unsuccessfully execution</strong></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">027</span> <span class="o">&gt;</span> <span class="no">Open3</span><span class="p">.</span><span class="nf">popen3</span><span class="p">(</span><span class="s1">'ls a'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">t</span><span class="o">|</span>
<span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">02</span><span class="mi">9</span><span class="p">?</span><span class="o">&gt;</span>   <span class="nb">p</span> <span class="n">e</span><span class="p">.</span><span class="nf">read</span>
<span class="mf">1.9</span><span class="o">.</span><span class="mi">3</span><span class="n">p429</span> <span class="p">:</span><span class="mo">030</span><span class="p">?</span><span class="o">&gt;</span>   <span class="k">end</span>
<span class="s2">"ls: a: No such file or directory</span><span class="se">\n</span><span class="s2">"</span>
 <span class="o">=&gt;</span> <span class="s2">"ls: a: No such file or directory</span><span class="se">\n</span><span class="s2">"</span></code></pre></figure>

<p>There are a few variations of popen3 methods such as popen2 where a couple of streams are merged 2&amp;&gt;1, for example.</p>

<h2 id="security-concerns">Security Concerns</h2>

<p>Much like SQL Injection, similar things can happen when using these method calls.
Consider a command like <code class="language-plaintext highlighter-rouge">ls a;rm a</code>.  or even worse <code class="language-plaintext highlighter-rouge">ls a;rm -rf *</code>
We can address such concerns with another form of popen3(cmd, args).  For the command above, it is
<code class="language-plaintext highlighter-rouge">popen3('ls', 'a;rm -rf*')</code>.  The last part of the command is interpreted as the options for <code class="language-plaintext highlighter-rouge">ls</code>.</p>

<p>Take a look at this playful little app <a href="https://github.com/zlu/web_shell">web_shell</a>.</p>


    </div>
  </div>
  <div class="footer">
    <div style="margin-top: 10px; margin-bottom: 10px;">
<a href="https://twitter.com/zlu" target="_blank" class="unstyled">
  <span class="icon-stack">
  <i class="icon-circle icon-stack-base icon-3x"></i>
  <i class="icon-twitter icon-2x icon-light"></i>
  </span>
</a>
<a href="http://linkedin.com/in/zhaolu" target="_blank" class="unstyled">
    <span class="icon-stack">
    <i class="icon-circle icon-stack-base icon-3x"></i>
    <i class="icon-linkedin icon-2x icon-light"></i>
    </span>
</a>
</div>
  </div>
</div>

</body>
</html>
